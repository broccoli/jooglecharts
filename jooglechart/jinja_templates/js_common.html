
<script>

$(document).ready(function() {

	/* GLOBALS AREA >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> */

	window.addEventListener('message', function(message) {
		// listener for sonar message from iframe parent
		if (message.data.msg.sonar_key !== undefined && message.data.msg.sonar_value !== undefined && 
				message.data.originId !== message.data.destinationId) {
			if (joogle_globals.sonar.handler_array !== undefined) {
				joogle_globals.sonar.call_handlers(message.data.msg);
			}
		}
	});

	console.log("{{ is_first_joogle }}");
	{% if is_first_joogle %}
	console.log("-- is first joogle");
	window.joogle_globals = null;
	{% endif %}

	console.log(typeof window.joogle_globals === "undefined");
	if (typeof window.joogle_globals === "undefined") {
		window.joogle_globals = {};
	
		window.joogle_globals.sonar = new (function () {
			// object for holding all sonar pieces
			this.handler_array = [];
			this.add_handler = function(handler) { this.handler_array.push(handler)};
			this.send = function(key, value) {
				var data = { sonar_key: key, sonar_value: value };
				if (window.self !== window.top) {
					window.parent.postMessage(data, window.location.origin + window.location.pathname);
				}
				if (joogle_globals.sonar.handler_array !== undefined) {
					joogle_globals.sonar.call_handlers(data);
				}
			}
			this.call_handlers = function(data) {
				console.log("----- calling all handlers: " + this.handler_array.length);
				for (var i = 0; i < this.handler_array.length; i++) {
					this.handler_array[i](data);
				}
			}
		})();
	}
	
	window.joogle_globals.update_category_filter = function(filter, selected_values) {
		// utility function for updating Google Charts filter		
		var filter_state = filter.getState();
		filter_state.selectedValues = selected_values;
		filter.setState(filter_state);
		filter.draw();
	}
	window.joogle_globals.update_range_filter = function(filter, range) {
		// utility function for updating Google Charts filter		
		var filter_state = filter.getState();
		filter_state.lowValue = range[0];
		filter_state.highValue = range[1];
		filter_state.lowThumbAtMinimum = false; // buggy without this
		filter_state.highThumbAtMaximum = false;
		filter.setState(filter_state);
		filter.draw();
	}
	window.joogle_globals.update_chart = function(values_arr, data, chartwrapper, column) {
		var filtered_rows = [];
		if (values_arr.length == 0) {
			filtered_rows = null;
		}
		else {
			for (var i = 0; i < values_arr.length; i++) {
				var rows = data.getFilteredRows([{column: column, value: values_arr[i]}]);
				filtered_rows = $.merge(filtered_rows, rows);
			}
		}
		chartwrapper.setView({
			rows: filtered_rows
		});
		chartwrapper.draw();			
	}

	window.joogle_globals.update_chart_range = function(minValue, maxValue, data, chartwrapper, column) {
		var rows = data.getFilteredRows([{column: column, minValue: minValue, maxValue: maxValue}]);
		chartwrapper.setView({
			rows: rows
		});
		chartwrapper.draw();			
	}
	

	/*
		The google.load function can only be called once per page.  On the first
		jooglechart, load the api and call loader with a callback.  For
		subsequent jooglecharts, just run the "callback" on its own
		after waiting to see of the google vis library is loaded.
	*/
	
	function when_google_vis_loaded (callback) {
		// check to see if google visualization library has been loaded.
		if (typeof window.google === 'undefined' || typeof window.google.visualization === 'undefined') {
			setTimeout (function () {
				when_google_vis_loaded (callback);
			}, 100); // wait 100 ms
		} else { callback (); }
	}
	
    // load visualization library    
    function google_loader(callback) {    
	    google.charts.load('current', {packages: ['table', 'corechart', 'controls']});
	    google.charts.setOnLoadCallback(callback);
    }
	
	window.joogle_globals.call_jooglechart_callback = function(callback) {
		if (typeof window.jooglechart_has_been_created === "undefined") {
			window.jooglechart_has_been_created = true;
			jQuery.getScript('https://www.gstatic.com/charts/loader.js', function( data, textStatus, jqxhr) {
		    	google_loader(callback);
			});
		} else {
			when_google_vis_loaded(callback);
		}
	}
	
	/* <<<<<<<<<<<<<<<<<<<<<<<<<<<<< GLOBALS AREA */

});

</script>