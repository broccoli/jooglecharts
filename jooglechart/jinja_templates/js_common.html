
<script>

$(document).ready(function() {

	/* GLOBALS AREA >>>>>>>>>>>>>>>>>>>>>>>>>>>>>> */

	window.addEventListener('message', function(msg) {
	// listener for sonar message from iframe parent
		if (msg.data.sonar_key !== undefined && msg.data.sonar_value !== undefined && msg.originId != msg.destinationId) {
			if (globals.sonar_handler_array !== undefined) {
				globals.sonar.call_handlers(msg.data);
			}
		}
	});


	window.globals = {};

	window.globals.sonar = new (function () {
		// object for holding all sonar pieces
		this.handler_array = []
		this.add_handler = function(handler) { this.handler_array.push(handler)};
		this.send = function(key, value) {
			var data = { sonar_key: key, sonar_value: value };
			if (window.self !== window.top) {
				window.parent.postMessage(data, window.location.origin + window.location.pathname);
			}
			if (globals.sonar.handler_array !== undefined) {
				globals.sonar.call_handlers(data);
			}
		}
		this.call_handlers = function(data) {
			for (i = 0; i < this.handler_array.length; i++) {
				this.handler_array[i](data);
			}
		}
	})();
	
	window.globals.update_category_filter = function(filter, selected_values) {
		// utility function for updating Google Charts filter
		var filter_state = filter.getState();
		filter_state.selectedValues = selected_values;
		filter.setState(filter_state);
		filter.draw();
	}
	window.globals.update_daterange_filter = function(filter, date_range) {
		// utility function for updating Google Charts filter		
		var filter_state = filter.getState();
		filter_state.lowValue = date_range[0];
		filter_state.highValue = date_range[1];
		filter_state.lowThumbAtMinimum = false; // buggy without this
		filter_state.highThumbAtMaximum = false;
		filter.setState(filter_state);
		filter.draw();		
	}
	window.globals.update_chart = function(values_arr, data, chartwrapper) {
		var filtered_rows = [];
		if (values_arr.length == 0) {
			filtered_rows = null;
		}
		else {
			for (var i = 0; i < values_arr.length; i++) {
				var rows = data.getFilteredRows([{column: 0, value: values_arr[i]}]);
				filtered_rows = $.merge(filtered_rows, rows);
			}
		}
		chartwrapper.setView({
			rows: filtered_rows
		});
		chartwrapper.draw();			
	}
	

	/*
		The google.load function can only be called once per page.  On the first
		jooglechart, load the api and call loader with a callback.  For
		subsequent jooglecharts, just run the "callback" on its own
		after waiting to see of the google vis library is loaded.
	*/
	
	function when_google_vis_loaded (callback) {
		// check to see if google visualization library has been loaded.
		if (typeof window.google === 'undefined' || typeof window.google.visualization === 'undefined') {
			setTimeout (function () {
				when_google_vis_loaded (callback);
			}, 100); // wait 100 ms
		} else { callback (); }
	}
	
    // load visualization library    
    function google_loader(callback) {    
	    google.charts.load('current', {packages: ['table', 'corechart', 'controls']});
	    google.charts.setOnLoadCallback(callback);
    }
	
	window.globals.call_jooglechart_callback = function(callback) {
		if (typeof window.jooglechart_has_been_created === "undefined") {
			window.jooglechart_has_been_created = true;
			jQuery.getScript('https://www.gstatic.com/charts/loader.js', function( data, textStatus, jqxhr) {
		    	google_loader(callback);
			});
		} else {
			when_google_vis_loaded(callback);
		}
	}
	
	/* <<<<<<<<<<<<<<<<<<<<<<<<<<<<< GLOBALS AREA */

});

</script>