
<script>

$(document).ready(function() {

	/* GLOBALS AREA >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> */

	window.addEventListener('message', function(message) {
		// listener for sonar message from iframe parent
		if (message.data.msg.sonar_key !== undefined && message.data.msg.sonar_value !== undefined && 
				message.data.originId !== message.data.destinationId) {
			if (joogle_globals.sonar.handler_array !== undefined) {
				joogle_globals.sonar.call_handlers(message.data.msg);
			}
		}
	});

	{% if refresh_globals %}
		window.joogle_globals = null;
	{% endif %}

	if (typeof window.joogle_globals === "undefined" || window.joogle_globals === null) {
		window.joogle_globals = {};
	
		window.joogle_globals.sonar = new (function () {
			// object for holding all sonar pieces
			this.handler_array = [];
			this.add_handler = function(handler) { this.handler_array.push(handler)};
			this.send = function(key, value) {
				var data = { sonar_key: key, sonar_value: value };
				if (window.self !== window.top) {
					window.parent.postMessage(data, window.location.origin + window.location.pathname);
				}
				if (joogle_globals.sonar.handler_array !== undefined) {
					joogle_globals.sonar.call_handlers(data);
				}
			}
			this.call_handlers = function(data) {
				for (var i = 0; i < this.handler_array.length; i++) {
					this.handler_array[i](data);
				}
			}
		})();
	}
	
	window.joogle_globals.update_category_filter = function(filter, selected_values) {
		// utility function for updating Google Charts filter		
		var filter_state = filter.getState();
		filter_state.selectedValues = selected_values;
		filter.setState(filter_state);
		filter.draw();
	}
	window.joogle_globals.update_range_filter = function(filter, range) {
		// utility function for updating Google Charts filter		
		var filter_state = filter.getState();
		filter_state.lowValue = range[0];
		filter_state.highValue = range[1];
		filter_state.lowThumbAtMinimum = false; // buggy without this
		filter_state.highThumbAtMaximum = false;
		filter.setState(filter_state);
		filter.draw();
	}
	window.joogle_globals.update_chart = function(values_arr, data, chartwrapper, column, view_cols) {
		var filtered_rows = joogle_globals.get_rows_for_column_selections(column, values_arr, data);
		chartwrapper.setView({
			rows: filtered_rows,
			columns: view_cols
		});
		chartwrapper.draw();			
	}

	window.joogle_globals.update_chart_range = function(minValue, maxValue, data, chartwrapper, column) {
		var rows = data.getFilteredRows([{column: column, minValue: minValue, maxValue: maxValue}]);
		chartwrapper.setView({
			rows: rows
		});
		chartwrapper.draw();			
	}
	
	window.joogle_globals.get_rows_for_column_selections = function(column, selections, datatable) {
		var rows_total = [];
		if (selections.length == 0) {
			rows_total = null;
		}
		else {
			for (var i = 0; i < selections.length; i++) {
				var rows = datatable.getFilteredRows([{column: parseInt(column), value: selections[i]}]);
				rows_total = $.merge(rows_total, rows);
			}
		}
		return rows_total;		
	}

	/*
		The google.load function can only be called once per page.  On the first
		jooglechart, load the api and call loader with a callback.  For
		subsequent jooglecharts, just run the "callback" on its own
		after waiting to see of the google vis library is loaded.
	*/
	
	function when_google_vis_loaded (callback) {
		// check to see if google visualization library has been loaded.
		if (typeof window.google === 'undefined' || typeof window.google.visualization === 'undefined') {
			setTimeout (function () {
				when_google_vis_loaded (callback);
			}, 100); // wait 100 ms
		} else { callback (); }
	}
	
    // load visualization library    
    function google_loader(callback) {    
	    google.charts.load('current', {packages: ['table', 'corechart', 'controls']});
	    google.charts.setOnLoadCallback(callback);
    }
	
	window.joogle_globals.call_jooglechart_callback = function(callback) {
		if (typeof window.jooglechart_has_been_created === "undefined") {
			window.jooglechart_has_been_created = true;
			jQuery.getScript('https://www.gstatic.com/charts/loader.js', function( data, textStatus, jqxhr) {
		    	google_loader(callback);
			});
		} else {
			when_google_vis_loaded(callback);
		}
	}
	
	/* <<<<<<<<<<<<<<<<<<<<<<<<<<<<< GLOBALS AREA */

});

</script>